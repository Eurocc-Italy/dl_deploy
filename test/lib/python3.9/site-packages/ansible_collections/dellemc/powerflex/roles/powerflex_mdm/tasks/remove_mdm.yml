---
- name: Include the mdm_set_facts.yml
  ansible.builtin.include_tasks: mdm_set_facts.yml

- name: MDM Cluster login
  ansible.builtin.command: >
    scli --login --mdm_ip {{ powerflex_mdm_primary_ip }}
    --username admin --password {{ powerflex_mdm_password }} --approve_certificate
  run_once: true
  ignore_errors: true
  register: powerflex_mdm_cluster_login
  changed_when: powerflex_mdm_cluster_login.rc == 0
  delegate_to: "{{ powerflex_mdm_primary_hostname }}"

- name: Remove secondary mdm
  ansible.builtin.command: >
    scli --remove_standby_mdm --remove_mdm_ip {{ powerflex_mdm_secondary_ip }}
  run_once: true
  register: powerflex_mdm_remove_secondary
  delegate_to: "{{ powerflex_mdm_primary_hostname }}"
  ignore_errors: true
  when: powerflex_mdm_secondary_ip is defined
  changed_when: powerflex_mdm_remove_secondary.rc == 0

- name: Remove tertiary mdm
  ansible.builtin.command: >
    scli --remove_standby_mdm --remove_mdm_ip {{ powerflex_mdm_tertiary_ip }}
  run_once: true
  register: powerflex_mdm_remove_tertiary
  delegate_to: "{{ powerflex_mdm_primary_hostname }}"
  ignore_errors: true
  when: powerflex_mdm_tertiary_ip is defined
  changed_when: powerflex_mdm_remove_tertiary.rc == 0

- name: Include uninstall_mdm.yml
  ansible.builtin.include_tasks: uninstall_mdm.yml
